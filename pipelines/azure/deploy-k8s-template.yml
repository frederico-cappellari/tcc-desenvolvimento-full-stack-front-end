# Template para deploy no kubernetes

parameters:
- name: Namespace
  type: string
- name: KubernetesServiceEndpoint
  type: string

steps:
- task: DownloadBuildArtifacts@0
  displayName: 'Download dos templates k8s'
  inputs:
    buildType: 'current'
    downloadType: 'single'
    artifactName: 'k8s-templates'
    downloadPath: '$(Pipeline.Workspace)'

- task: replacetokens@6
  displayName: 'Substitui tokens por variáveis nos templates k8s'
  inputs:
    root: '$(Pipeline.Workspace)/k8s-templates'
    sources: '**/*.yml'
    tokenPattern: 'custom'
    tokenPrefix: '%'
    tokenSuffix: '%'
    addBOM: true
    missingVarLog: 'error'
    ifNoFilesFound: 'error'

- task: Kubernetes@1
  displayName: 'Kubectl apply para atualização do cluster k8s'
  inputs:
    connectionType: 'Kubernetes Service Connection'
    kubernetesServiceEndpoint: '${{ parameters.KubernetesServiceEndpoint }}'
    namespace: '${{ parameters.Namespace }}'
    command: 'apply'
    arguments: '-f $(Pipeline.Workspace)/k8s-templates'